name: Build Mercury for Arch Linux

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    # Build daily at 06:00 UTC
    - cron: '0 6 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
    - name: Update Arch Linux and install dependencies
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm base-devel git mercurial python python-pip rust clang llvm lld \
          cmake ninja autoconf bison flex gawk curl wget tar zip unzip p7zip \
          libjpeg-turbo libpng libwebp libtiff libvpx libevent nss nspr \
          gtk3 dbus-glib alsa-lib pulseaudio mesa libpulse \
          libxt libx11 libxrender libxcomposite libxdamage libxfixes \
          libxext libxi libxcursor libxrandr libxss libxxf86vm \
          libxinerama libglvnd wayland libva mesa-vdpau vulkan-icd-loader \
          yasm nasm nodejs npm

    - name: Install additional build tools
      run: |
        # Create virtual environment for Python packages
        python -m venv /opt/build-venv
        source /opt/build-venv/bin/activate
        pip install --upgrade pip
        pip install virtualenv
        # Install Mozilla build system dependencies
        pip install requests pytoml

    - name: Checkout Mercury repository
      uses: actions/checkout@v4
      with:
        path: mercury-source

    - name: Setup environment
      run: |
        # Create build directories
        mkdir -p /home/runner/mozilla-unified
        mkdir -p /home/runner/Mercury

        # Copy Mercury source to expected location
        cp -r mercury-source/* /home/runner/Mercury/
        cd /home/runner/Mercury

        # Make scripts executable
        chmod +x *.sh

    - name: Bootstrap Mozilla source
      run: |
        source /opt/build-venv/bin/activate
        cd /home/runner
        # Set TERM to avoid tput errors
        export TERM=xterm
        # Manually clone mozilla-unified using Mercurial (not Git)
        echo "Cloning mozilla-unified repository with Mercurial..."
        hg clone https://hg.mozilla.org/mozilla-unified mozilla-unified
        cd mozilla-unified
        # Skip mach bootstrap since we've installed all dependencies manually
        echo "Skipping mach bootstrap - dependencies already installed manually"
        # Verify the repository structure
        ls -la /home/runner/mozilla-unified/
      env:
        HOME: /home/runner

    - name: Setup Mercury build
      run: |
        cd /home/runner/Mercury
        export TERM=xterm
        # Create a minimal mozconfig inline to avoid file path issues
        cat > /home/runner/mozilla-unified/mozconfig << 'EOF'
# Minimal mozconfig for GitHub Actions build

# Build only Firefox browser
ac_add_options --enable-application=browser

# Build for Linux
ac_add_options --target=x86_64-pc-linux-gnu
ac_add_options --enable-default-toolkit=cairo-gtk3-x11-wayland

# Optimization settings
ac_add_options --enable-release
ac_add_options --disable-debug
ac_add_options --disable-debug-symbols
ac_add_options --disable-tests
ac_add_options --enable-strip

# Basic features
ac_add_options --enable-sandbox
ac_add_options --enable-webrtc
ac_add_options --enable-pulseaudio
ac_add_options --enable-alsa

# Branding
ac_add_options --with-app-name=mercury
ac_add_options --with-app-basename=Mercury
ac_add_options --with-branding=browser/branding/mercury
ac_add_options --with-distribution-id=com.alex313031.mercury

# Make flags
mk_add_options MOZ_MAKE_FLAGS="-j$(nproc)"

# Autoclobber
mk_add_options AUTOCLOBBER=1
EOF
        # Copy Mercury source files
        cp -r -v ./app/. /home/runner/mozilla-unified/browser/app/
        cp -r -v ./browser/. /home/runner/mozilla-unified/browser/
        cp -r -v ./build/. /home/runner/mozilla-unified/build/
        cp -r -v ./devtools/. /home/runner/mozilla-unified/devtools/
        cp -r -v ./ipc/. /home/runner/mozilla-unified/ipc/
        cp -r -v ./moz.build /home/runner/mozilla-unified/
        cp -r -v ./netwerk/. /home/runner/mozilla-unified/netwerk/
        cp -r -v ./other-licenses/. /home/runner/mozilla-unified/other-licenses/
        mkdir -p -v /home/runner/mozilla-unified/policies
        cp -r -v ./policies/. /home/runner/mozilla-unified/policies/
        cp -r -v ./toolkit/. /home/runner/mozilla-unified/toolkit/
        cp -r -v ./testing/. /home/runner/mozilla-unified/testing/
        cp -v ./mozconfigs/ga /home/runner/mozilla-unified/
      env:
        HOME: /home/runner
        HG_SRC_DIR: /home/runner/mozilla-unified

    - name: Build Mercury
      run: |
        cd /home/runner/Mercury
        export MOZ_MAKE_FLAGS="-j$(nproc)"
        export TERM=xterm
        ./build.sh
      env:
        HOME: /home/runner
        HG_SRC_DIR: /home/runner/mozilla-unified
        MOZ_MAKE_FLAGS: "-j$(nproc)"
      timeout-minutes: 120

    - name: Package Mercury
      run: |
        cd /home/runner/Mercury
        export TERM=xterm
        ./package.sh
      env:
        HOME: /home/runner
        HG_SRC_DIR: /home/runner/mozilla-unified

    - name: Find and copy built package
      run: |
        cd /home/runner/mozilla-unified
        find . -name "Mercury*.tar.bz2" -type f | head -1 | xargs -I {} cp {} /home/runner/
        ls -la /home/runner/*.tar.bz2

    - name: Upload built package
      uses: actions/upload-artifact@v4
      with:
        name: mercury-arch-linux
        path: /home/runner/*.tar.bz2
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Download built package
      uses: actions/download-artifact@v4
      with:
        name: mercury-arch-linux

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: Mercury*.tar.bz2
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}